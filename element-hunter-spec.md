# ELEMENT HUNTER 仕様書

## 概要

### コンセプト

> 私は**エレメントハンター**。
> 逃げ出したHTML要素をハントするのが仕事だ。
> 今日の舞台は **Agile Studio**。
> さあ、さっさと捕まえてコンテンツを取り戻してやるぜ。

実在のWebサイトがダンジョンになる2D探索アクションゲーム。
HTML要素が敵として出現し、「ハント」することでページコンテンツが読める。
サイト販促ゲーミフィケーションツールとしても機能する。

### 現在のモード: サイト販促モード（MVP）
- ランダムに選ばれたターゲットページをクリアするタイムアタック
- ページ内の全敵をハントするとページコンテンツがアンロック
- 2カラムレイアウトでゲーム画面とコンテンツを並列表示
- ボスがいるページは通常敵を全滅させた後、ボスを倒す必要あり

### インスピレーション
- ドルアーガの塔（探索・アイテム収集）
- ドラゴンバスター（戦闘・操作感）
- グラディウス（パワーアップシステム）
- ハクスラ系（テンポ・収集欲）
- ゼビウス（ボス戦のドローンSE）

### ターゲットプラットフォーム
- ブラウザ（HTML5 Canvas / WebGL）
- キーボード操作
- スマホ（タッチ操作 / 仮想ジョイスティック）

---

## ゲームルール

### 難易度

| モード | ターゲット数 | 敵の数 | ボスHP | 目安時間 |
|--------|--------------|--------|--------|----------|
| EASY | 3ページ | 少なめ (4-6体) | 軽め (パーツ数×1) | 約1分 |
| NORMAL | 5ページ | 通常 (12-20体) | 重め (パーツ数×2) | 約2-3分 |

### マップ構造

```
1ページ = 1部屋
```

- **横幅（X）**: コンテンツ量に比例して可変
  - `横幅 = 基本幅 + (要素数 × 係数) + (文字数 ÷ 係数)`
  - 最小幅: 1画面分
  - 最大幅: 制限あり（要調整）
- **高さ（Y）**: 固定（1画面）
- **敵の配置**: DOM順に左から右へ配置（Y座標はランダム）

### ポータル（部屋間移動）

ページ内のリンクがポータルとして表示される。

| 種類 | 表示 | 色 | 挙動 |
|------|------|-----|------|
| 未訪問 | `[ページタイトル]` | 水色（点滅） | 剣で攻撃して遷移 |
| 訪問済み | `[ページタイトル]` | 紫 | 剣で攻撃して遷移 |
| ターゲット | `★[ページタイトル]` | 金 | ターゲットページへ直接 |
| 経路上 | `☆[ページタイトル]` | 黄緑 | ターゲットへの経路上 |
| アクセス不可 | `[ページタイトル]` | グレー | 遷移不可（メッセージ表示） |

- **動き**: 横方向に往復 + 縦方向にゆらゆら揺れる
- **遷移方法**: 剣で攻撃すると遷移（触れただけでは遷移しない）
- **遷移演出**: フェードアウト + "WARP" テキスト表示
- **遷移条件**: リンク先がクロール済みの場合のみ遷移可能
- **配置数**: ステージ幅に応じて動的に決定（800px基準で20個）
- **共通リンク**: ナビメニュー等の共通リンク（commonLinks）も表示

### TOPポータル

- 各ステージ右端に `[TOP]` が配置される（トップページ以外）
- 剣で攻撃するとトップページ（/）に戻る（他ポータルと同じ操作）
- 水色 + 点滅アニメーション（他ポータルと同じスタイル）

### ゴール条件（サイト販促モード）

- ゲーム開始時、ターゲットページを選択
  - EASY: 3ページ（トップ + 浅いページ2つ）
  - NORMAL: 5ページ（ランダム選択）
  - トップページは除外
  - BFS探索で到達可能なページのみ選択
- 各ターゲットページの**全敵 + ボス（いる場合）をハント**するとページ「クリア」
- 全ターゲットページをクリアした**時間を競う**タイムアタック形式

---

## ボスシステム

### ボス出現条件

テキストを持たないHTML構造要素（`<section>`, `<article>`, `<nav>`など）が多いページで出現。

- 条件: sampleTextsが空の要素（img, div, a除く）が10個以上
- 通常敵を全滅させると **"WARNING!"** 演出後にボス登場

### ボスの構成

- **パーツ**: テキストを持たないHTML構造要素のタグ名
- **表示**: 各パーツ `<tagname>` が円形に配置され回転
- **HP**: パーツ数 × モード係数（EASY: ×1, NORMAL: ×2）
- **色**: タグごとに色分け（section: 赤、article: オレンジ、nav: 緑など）

### ボスの動き

- 円形に回転しながら移動
- 壁で反射
- 回転速度: 0.8 rad/s
- 移動速度: 40 px/s

### ボス戦の流れ

1. 通常敵を全滅させる
2. "WARNING!" 演出（2秒間、画面暗転 + 点滅テキスト）
3. ボス登場 + ドローンSE開始
4. ボスを倒す（HP0でグレー化 + 停止）
5. ページクリア

### ボスのダメージ

- 接触ダメージ: 2（通常敵より高い）
- レーザーでダメージを与える（通常敵と同じ）

---

## バーストシステム

高速移動でレーザーがパワーアップ。

### 速度とダメージ

| 速度ゲージ | 貫通 | ダメージ | 効果 |
|-----------|------|---------|------|
| 0-49% | なし | 1 | 通常レーザー |
| 50-99% | あり | 2 | 中バースト（貫通） |
| 100% | あり | 3 | **MAXバースト**（最大火力） |

### 敵のHP（レアリティ別・固定値）

| レアリティ | HP | 通常 | 中バースト | MAXバースト |
|-----------|-----|------|-----------|------------|
| ★1 白 | 1 | 1発 | 1発 | 1発 |
| ★2 緑 | 2 | 2発 | 1発 | 1発 |
| ★3 青 | 3 | 3発 | 2発 | 1発 |
| ★4 紫 | 6 | 6発 | 3発 | 2発 |
| ★5 金 | 9 | 9発 | 5発 | 3発 |

### コンボボーナス

- 1発で複数敵を倒すとタイム短縮
- 2コンボ: -4秒、3コンボ: -8秒...（指数関数的）

---

## キャラクター

### プレイヤー

- **表示**: 三角形（宇宙船スタイル）+ 噴射エフェクト
- **HP**: 初期値 5
- **移動**: 慣性移動（加速・減速・摩擦）
- **攻撃**: 前方にレーザー（速度連動）
- **壁**: 跳ね返り

### 敵（HTML要素）

敵はHTML要素のタグ名がそのまま表示される。

#### レアリティと強さ

| レアリティ | 色 | タグ例 | HP | 攻撃力 | 動き |
|-----------|-----|--------|-----|--------|------|
| ★☆☆☆☆ | 白 | `<p>`, `<span>`, `<div>`, `<li>`, `<img>` | 1 | 1 | 単純 |
| ★★☆☆☆ | 緑 | `<h6>`-`<h4>`, `<ul>`, `<table>`, `<form>`, `<button>`, `<input>` | 2 | 2-3 | 追尾・射撃 |
| ★★★☆☆ | 青 | `<h3>`-`<h1>`, `<article>`, `<section>`, `<video>`, `<audio>`, `<canvas>`, `<iframe>` | 3 | 4-6 | 追尾・特殊攻撃 |
| ★★★★☆ | 紫 | `<dialog>`, `<template>`, `<details>`, `<meter>`, `<progress>`, `<svg>`, `<picture>`, `<mark>` | 6 | 5-8 | 分身・透明化等 |
| ★★★★★ | 金（光る） | `<ruby>`, `<bdo>`, `<wbr>`, `<data>`, `<slot>`, `<output>` | 9 | 8-15 | 特殊能力持ち |

#### 配置数

敵の配置数はバランスを考慮して制限される：
- **EASY**: 4-6体
- **NORMAL**: 12-20体
- **タグ毎上限**: EASY: 2体、NORMAL: 3体
- **配置条件**:
  - imgタグ: sampleImageUrlsを持つ場合のみ出現
  - その他タグ: sampleTextsを持つ場合のみ出現

#### 動きパターン

| パターン | 対象タグ例 | 挙動 |
|----------|-----------|------|
| 往復 | `<p>` | 左右に往復、壁で反転 |
| ランダム | `<span>` | 不規則に方向転換 |
| 巡回 | `<div>` | 決まったルートを周回 |
| 編隊 | `<li>` | 複数が並んで動く |
| 射撃 | `<img>` | 停止して弾を撃つ |
| 追尾（遅） | `<table>` | ゆっくりプレイヤーを追う |
| 追尾（速） | `<h1>` | 積極的にプレイヤーを追う |

#### ハントした時

- HPを0にすると敵が「ハント」される（消えない）
- ハントされた敵は画面に残る（色がグレー化、動きが止まる）
- ハントされた敵は無害（衝突してもダメージなし）
- **ページ間を移動しても敵の状態（ハント/配置）は保持される**
- ページ内の全敵がハント → ボスがいれば出現 → ボスも倒すとページクリア
- **imgタグの敵をハントすると、そのタグが持つ画像がポップアップ表示される**

---

## 操作

### キーボード

| キー | アクション |
|------|-----------|
| 矢印キー or WASD | 8方向移動 |
| Z or Space | 攻撃（レーザー） |
| ESC | ポーズ |

### タッチ操作（スマホ）

| 操作 | 説明 |
|------|------|
| 左下ジョイスティック | 移動（慣性あり） |
| 右下FIREボタン | レーザー発射 |
| 右上||ボタン | ポーズ |

---

## サウンド

Web Audio APIで生成するチップチューン風効果音。

### 効果音一覧

| 場面 | 説明 |
|------|------|
| レーザー発射 | 周波数スイープ（貫通時は重厚） |
| 敵ハント | 上昇音 + ノイズ |
| ダメージ | 低い下降音 + ノイズ |
| ワープ | シュワーッという上昇スイープ |
| コンボ | アルペジオ（コンボ数でピッチ上昇） |
| ページクリア | ファンファーレ（C-E-G-C） |
| ゲームオーバー | 下降音 |
| ゲームクリア | 壮大なファンファーレ |
| メニュー移動 | 短いピッ音 |
| ゲーム開始 | 上昇アルペジオ |
| ボス警告 | 甲高いねじれ警告アラーム（約2秒） |
| ボスループ | アンドアジェネシス風低音ドローン |

### ボスサウンド詳細

**警告音 (playBossWarningSound)**
- 2つのオシレーター（sawtooth + square）
- 周波数を上下にうねらせて「ねじり」効果
- 約2秒間、6回繰り返し

**ドローン音 (startBossLoopSound / stopBossLoopSound)**
- 複数の低音オシレーター（55Hz, 82.5Hz, 110Hz）
- LFOで周波数を微妙に揺らす
- パルス的なアクセント音が周期的に鳴る
- ボス撃破・ワープ・ゲームオーバー時に停止

---

## ビジュアル

### 方針

テキストベースのミニマルデザイン。

### 表示例（サイト販促モード）

```
┌─────────────────────────────────┬──────────────────────┐
│ [GAME AREA - 800x600]           │ [CONTENT PANEL]      │
│                                 │                      │
│  ▶     <p>  <p>     <div>  [TOP]│ Timer: 00:45         │
│              <p>        <img>   │ Progress: 2/5        │
│     <span> <span>    <table>    │ ━━━━━━━━             │
│                                 │                      │
│  [ページタイトル] [ブログ..]    │ Targets:             │
│                                 │ ✓ /about             │
│ HP: *****    Hunted: 3/12       │ ○ /products (現在)   │
│ Path: /products                 │ ○ /contact           │
│                                 │                      │
│                                 │ [ページコンテンツ]   │
│                                 │ Hunt all enemies     │
│                                 │ to unlock content    │
└─────────────────────────────────┴──────────────────────┘
```

### 要素の表示

| 要素 | 表示 | 備考 |
|------|------|------|
| プレイヤー | 三角形 | 向きで回転、噴射エフェクト付き |
| 敵 | `<tagname>` | レアリティで色変化 |
| ボス | 複数の `<tagname>` | 円形配置で回転 |
| ポータル | `[タイトル]` | リンク先ページのタイトル |
| TOPポータル | `[TOP]` | 常にトップページへ戻る |

### 色（レアリティ）

| レアリティ | 色コード |
|-----------|----------|
| ★1 | `#FFFFFF`（白） |
| ★2 | `#00FF00`（緑） |
| ★3 | `#0088FF`（青） |
| ★4 | `#AA00FF`（紫） |
| ★5 | `#FFD700`（金）+ 点滅 |

### 色（ポータル）

| 状態 | RGB | 説明 |
|------|-----|------|
| 未訪問 | `(0, 200, 255)` | 水色（点滅） |
| 訪問済み | `(180, 100, 255)` | 紫 |
| ターゲット | `(255, 215, 0)` | 金（★マーク） |
| 経路上 | `(150, 255, 100)` | 黄緑（☆マーク） |
| アクセス不可 | `(100, 100, 100)` | グレー |
| ハントされた敵 | `(100, 100, 100)` | グレー（半透明） |

### 色（ボスパーツ）

| タグ | 色コード |
|------|----------|
| section | `#ff6b6b` |
| article | `#ffa502` |
| aside | `#ff7f50` |
| header | `#70a1ff` |
| footer | `#5352ed` |
| nav | `#2ed573` |
| main | `#ff4757` |
| figure | `#eccc68` |
| その他 | `#b2bec3` |

---

## 技術仕様

### 技術スタック

| レイヤー | 技術 |
|----------|------|
| フレームワーク | Kaboom.js |
| 言語 | TypeScript |
| バンドラー | Vite |
| データ形式 | JSON |
| サウンド | Web Audio API |
| クローラー | Playwright |

### ディレクトリ構成

```
element-hunter/
├── src/
│   ├── main.ts          # エントリーポイント
│   ├── scenes/
│   │   ├── title.ts     # タイトル画面
│   │   ├── game.ts      # メインゲーム
│   │   └── complete.ts  # クリア画面
│   ├── entities/
│   │   ├── player.ts    # プレイヤー（宇宙船）
│   │   ├── enemy.ts     # 通常敵
│   │   ├── boss.ts      # ボス
│   │   └── portal.ts    # ポータル
│   ├── systems/
│   │   ├── sound.ts     # 効果音システム
│   │   ├── stageLoader.ts # ステージ生成
│   │   └── gameState.ts # ゲーム状態管理
│   ├── ui/
│   │   ├── ContentPanel.ts # コンテンツパネル
│   │   └── VirtualJoystick.ts # タッチ操作
│   ├── data/
│   │   ├── elements.ts  # HTML要素定義
│   │   └── siteLoader.ts # サイトデータ読み込み
│   └── types/
│       └── index.ts     # 型定義
├── data/
│   └── sites/           # クロール済みサイトデータ
│       ├── tutorial.json
│       └── example.json
├── tools/
│   └── crawler/         # クロールツール
│       ├── index.ts
│       └── package.json
├── public/
├── index.html
├── package.json
└── vite.config.ts
```

### サイトデータ形式（JSON）

```json
{
  "siteId": "example-corp",
  "siteName": "Example株式会社",
  "baseUrl": "https://example.com",
  "pages": [
    {
      "path": "/",
      "depth": 0,
      "title": "トップページ",
      "elements": [
        {
          "tag": "h1",
          "count": 1,
          "sampleTexts": ["会社概要"]
        },
        {
          "tag": "img",
          "count": 8,
          "sampleImageUrls": ["https://..."]
        }
      ],
      "links": ["/about", "/products", "/contact"],
      "estimatedWidth": 1200
    }
  ],
  "commonLinks": ["/", "/about", "/contact"],
  "metadata": {
    "totalPages": 10,
    "crawledAt": "2024-01-01T00:00:00Z"
  }
}
```

### クロールツール要件

- Playwright 使用
- 入力: URL（トップページ）+ 深度制限
- 出力: JSON（上記形式）
- 機能:
  - JSレンダリング後のDOMを取得
  - 内部リンクを再帰的にクロール
  - 深度制限（無限ループ防止）
  - 共通リンクの検出
  - テキスト・画像URLの収集

---

## MVP（Phase 1）- 完了

### 範囲

最小限の動くプロトタイプ。

#### 含むもの

- [x] 1部屋固定（ハードコードでOK）
- [x] プレイヤー移動（8方向）
- [x] 攻撃（前方に判定）
- [x] 敵3種（`<p>`, `<div>`, `<h1>`）
  - 各1パターンの動き
  - 倒すと消える
- [x] 右端にゴール（触れたらクリア表示）
- [x] HP表示（敵に当たるとダメージ）

### 完了条件

- ゲームが起動する
- プレイヤーを操作できる
- 敵が動いて、攻撃で倒せる
- 敵に当たるとダメージを受ける
- 右端でクリア表示が出る

---

## Phase 2（サイト販促モード）- 完了

- [x] JSON読み込み → 部屋生成
- [x] 複数部屋 + ポータルでの移動
- [x] ポータルは剣で攻撃して遷移（連続遷移防止）
- [x] ワープ演出（フェード + "WARP" テキスト）
- [x] 訪問済みポータルの色変更（紫色）
- [x] ポータルにページタイトル表示
- [x] TOPポータル（常にトップページに戻る）
- [x] 共通リンク（commonLinks）を経路探索に含める
- [x] 共通リンクをポータルとして表示
- [x] 敵のハントシステムと状態永続化
- [x] ページクリア判定
- [x] ターゲットページ選択（BFS到達可能判定）
- [x] 2カラムレイアウト（ゲーム + コンテンツパネル）
- [x] コンテンツパネルUI（タイトル、進捗、ターゲット一覧、テキスト表示）
- [x] タイマー（経過時間計測、ゲームオーバー/完了で停止）
- [x] HP永続化（ページ間で保持）
- [x] ゲーム完了シーン
- [x] ゲームオーバー + リトライ
- [x] クローラー拡張（テキスト・画像取得）
- [x] imgタグハント時の画像ポップアップ表示

---

## Phase 3（ゲーム体験向上）- 完了

- [x] タイトル画面（コンセプトテキスト + サイト名表示）
- [x] モード選択（EASY / NORMAL）
  - EASY: 3ページ（トップ + 浅いページ2つ）、ターゲットへのリンクのみ表示
  - NORMAL: 5ページ（ランダム選択）
- [x] プレイヤー操作改善
  - 宇宙船スタイル（三角形 + 噴射エフェクト）
  - 慣性移動（加速・減速・摩擦）
  - 壁での跳ね返り
- [x] レーザー攻撃システム
  - 速度連動（速いほど長く・太く・貫通）
  - 貫通レーザー（速度50%以上で複数敵を貫通）
  - ダメージ量が速度に応じて増加
- [x] コンボボーナス
  - 1発で複数敵を倒すとタイム短縮
  - 2コンボ: -4秒、3コンボ: -8秒...（指数関数的）
- [x] TOPポータル改善
  - 他ポータルと同じ水色+点滅スタイル
  - レーザーで遷移（統一操作）
  - トップページでは非表示
- [x] ゲームオーバー/完了からタイトル画面に戻る

---

## Phase 4（ボス・サウンド・モバイル）- 完了

- [x] ボスシステム
  - 2段階制（通常敵 → ボス）
  - WARNING! 演出（暗転 + 点滅テキスト）
  - 回転しながら移動するボス
  - パーツ構成（タグごとに色分け）
  - HP: パーツ数 × モード係数
- [x] サウンドシステム（Web Audio API）
  - チップチューン風効果音
  - ボス警告音（ねじれ警告アラーム）
  - ボスドローン音（アンドアジェネシス風）
  - 各種ゲームイベントSE
- [x] スマホ対応
  - タッチデバイス判定
  - 仮想ジョイスティック（左下）
  - FIREボタン（右下）
  - ポーズボタン（右上）
- [x] ゲームバランス調整
  - 敵HPを固定値に変更（ランダム廃止）
  - バースト仕様に合わせたHP設計
  - モード別ボスHP調整
- [x] ポータルナビゲーション強化
  - ターゲットページへのポータルに★マーク
  - 経路上のポータルに☆マーク
  - EASYモードはターゲットへのリンクのみ表示
- [x] サイト選択画面
  - 複数サイト対応（data/sites/内のJSON）
  - 2段階選択（サイト → 難易度）
  - タッチ対応

---

## 今後の改善案

- [ ] BGM
- [ ] ダメージ演出強化
- [ ] ゲームパッド対応
- [ ] HARDモード（より多くのターゲット、敵が強い）
- [ ] ランキング機能

---

## 備考

### 法的考慮

- 事前クロールするサイトは許可を取るか、自作する
- 収集したデータはゲームにバンドルし、リアルタイムクロールはしない

### バランス調整

- HP、攻撃力、移動速度等の数値は仮
- プレイしながら調整

---

## 将来構想（アイディアノート）

以下は現在のタイムアタックモードとは別軸の構想。実装予定なし。

### 図鑑モード

敵を「倒す」（消える）形式で、HTML要素を収集する長期プレイモード。

- 敵を倒すと図鑑に登録
- 全HTML要素（約118種）のコンプリートが目標
- レアリティ表示、収集率表示
- 称号システム（50%: HTML見習い、100%: HTMLマスター）
- セーブ/ロード機能

### パワーアップシステム（グラディウス式）

```
[回復] → [攻撃UP] → [速度UP] → [無敵] → [全体攻撃]
  1個      2個        3個        4個        5個
```

- 敵を倒すとカプセルドロップ
- カプセル取得でゲージ+1
- ボタンで効果発動、ゲージリセット

### 障害物システム

| 種類 | 表示 | 耐久 | ドロップ |
|------|------|------|----------|
| 箱 | `[箱]` | 1発 | ランダム |
| 樽 | `[樽]` | 1発 | ランダム |
| 岩 | `[岩]` | 2-3発 | 良いものが出やすい |

### その他アイディア

- マルチプレイ（同じサイトを複数人で探索）
- デイリーチャレンジ（日替わりサイト）
- 外部リンク → 別サイトへワープ
- ランキング機能
