# ELEMENT HUNTER 仕様書

## 概要

### コンセプト

> 私は**エレメントハンター**。
> 逃げ出したHTML要素をハントするのが仕事だ。
> 今日の舞台は **Agile Studio**。
> さあ、さっさと捕まえてコンテンツを取り戻してやるぜ。

実在のWebサイトがダンジョンになる2D探索アクションゲーム。
HTML要素が敵として出現し、「停止」させることでページコンテンツが読める。
サイト販促ゲーミフィケーションツールとしても機能する。

### 現在のモード: サイト販促モード（MVP）
- ランダムに選ばれた5つのターゲットページをクリアするタイムアタック
- ページ内の全敵を停止させるとページコンテンツがアンロック
- 2カラムレイアウトでゲーム画面とコンテンツを並列表示

### インスピレーション
- ドルアーガの塔（探索・アイテム収集）
- ドラゴンバスター（戦闘・操作感）
- グラディウス（パワーアップシステム）
- ハクスラ系（テンポ・収集欲）

### ターゲットプラットフォーム
- ブラウザ（HTML5 Canvas / WebGL）
- キーボード操作（将来的にゲームパッド対応）

---

## ゲームルール

### マップ構造

```
1ページ = 1部屋
```

- **横幅（X）**: コンテンツ量に比例して可変
  - `横幅 = 基本幅 + (要素数 × 係数) + (文字数 ÷ 係数)`
  - 最小幅: 1画面分
  - 最大幅: 制限あり（要調整）
- **高さ（Y）**: 固定（1画面）
- **敵の配置**: DOM順に左から右へ配置（Y座標はランダム）

### ポータル（部屋間移動）

ページ内のリンクがポータルとして表示される。

| 種類 | 表示 | 色 | 挙動 |
|------|------|-----|------|
| 未訪問 | `[ページタイトル]` | 水色（点滅） | 剣で攻撃して遷移 |
| 訪問済み | `[ページタイトル]` | 紫 | 剣で攻撃して遷移 |
| アクセス不可 | `[ページタイトル]` | グレー | 遷移不可（メッセージ表示） |

- **動き**: 横方向に往復 + 縦方向にゆらゆら揺れる
- **遷移方法**: 剣で攻撃すると遷移（触れただけでは遷移しない）
- **遷移演出**: フェードアウト + "WARP" テキスト表示
- **遷移条件**: リンク先がクロール済みの場合のみ遷移可能
- **配置数**: ステージ幅に応じて動的に決定（800px基準で20個）
- **共通リンク**: ナビメニュー等の共通リンク（commonLinks）も表示

### TOPポータル

- 各ステージ右端に `[TOP]` が配置される
- 触れるとトップページ（/）に戻る
- トップページにいる場合はメッセージ表示

### ゴール条件（サイト販促モード）

- ゲーム開始時、ランダムに5ページを「ターゲットページ」として選択
  - トップページは除外
  - BFS探索で到達可能なページのみ選択
- 各ターゲットページの**全敵を停止**させるとページ「クリア」
- 全5ページをクリアした**時間を競う**タイムアタック形式

---

## キャラクター

### プレイヤー

- **表示**: `▶`（向きで変化可）
- **HP**: 初期値（要調整、例: 5）
- **移動速度**: 固定（パワーアップで一時強化可）
- **攻撃**: 前方に剣（短距離）

### 敵（HTML要素）

敵はHTML要素のタグ名がそのまま表示される。

#### レアリティと強さ

| レアリティ | 色 | タグ例 | HP | 攻撃力 | 動き |
|-----------|-----|--------|-----|--------|------|
| ★☆☆☆☆ | 白 | `<p>`, `<span>`, `<div>`, `<li>`, `<img>` | 1-2 | 1 | 単純 |
| ★★☆☆☆ | 緑 | `<h6>`-`<h4>`, `<ul>`, `<table>`, `<form>`, `<button>`, `<input>` | 3-8 | 2-3 | 追尾・射撃 |
| ★★★☆☆ | 青 | `<h3>`-`<h1>`, `<article>`, `<section>`, `<video>`, `<audio>`, `<canvas>`, `<iframe>` | 7-15 | 4-6 | 追尾・特殊攻撃 |
| ★★★★☆ | 紫 | `<dialog>`, `<template>`, `<details>`, `<meter>`, `<progress>`, `<svg>`, `<picture>`, `<mark>` | 10-20 | 5-8 | 分身・透明化等 |
| ★★★★★ | 金（光る） | `<ruby>`, `<bdo>`, `<wbr>`, `<data>`, `<slot>`, `<output>` | 20-30 | 8-15 | 特殊能力持ち |

#### 配置数

敵の配置数はステージ幅に応じて動的に決定される：
- 基準: 800px幅で最大50体
- 計算式: `MAX_ENEMIES = 50 × (stageWidth / 800)`
- 例: 4000px幅のステージでは最大250体

#### 動きパターン

| パターン | 対象タグ例 | 挙動 |
|----------|-----------|------|
| 往復 | `<p>` | 左右に往復、壁で反転 |
| ランダム | `<span>` | 不規則に方向転換 |
| 巡回 | `<div>` | 決まったルートを周回 |
| 編隊 | `<li>` | 複数が並んで動く |
| 射撃 | `<img>` | 停止して弾を撃つ |
| 追尾（遅） | `<table>` | ゆっくりプレイヤーを追う |
| 追尾（速） | `<h1>` | 積極的にプレイヤーを追う |

#### 停止した時

- HPを0にすると敵が「停止」する（消えない）
- 停止した敵は画面に残る（色がグレー化、動きが止まる）
- 停止した敵は無害（衝突してもダメージなし）
- **ページ間を移動しても敵の状態（停止/配置）は保持される**
- ページ内の全敵が停止 → コンテンツが読める状態 → ページクリア

---

## 操作

### キーボード

| キー | アクション |
|------|-----------|
| 矢印キー or WASD | 8方向移動 |
| Z or Space | 攻撃（剣） |
| ESC | ポーズ |

---

## ビジュアル

### 方針

テキストベースのミニマルデザイン。

### 表示例（サイト販促モード）

```
┌─────────────────────────────────┬──────────────────────┐
│ [GAME AREA - 800x600]           │ [CONTENT PANEL]      │
│                                 │                      │
│  ▶     <p>  <p>     <div>  [TOP]│ Timer: 00:45         │
│              <p>        <img>   │ Progress: 2/5        │
│     <span> <span>    <table>    │ ━━━━━━━━             │
│                                 │                      │
│  [ページタイトル] [ブログ..]    │ Targets:             │
│                                 │ ✓ /about             │
│ HP: *****    Stopped: 3/12      │ ○ /products (現在)   │
│ Path: /products                 │ ○ /contact           │
│                                 │                      │
│                                 │ [ページコンテンツ]   │
│                                 │ Stop all enemies     │
│                                 │ to unlock content    │
└─────────────────────────────────┴──────────────────────┘
```

### 要素の表示

| 要素 | 表示 | 備考 |
|------|------|------|
| プレイヤー | `▶` | 向きで `▲▼◀▶` |
| 敵 | `<tagname>` | レアリティで色変化 |
| ポータル | `[タイトル]` | リンク先ページのタイトル |
| TOPポータル | `[TOP]` | 常にトップページへ戻る |

### 色（レアリティ）

| レアリティ | 色コード |
|-----------|----------|
| ★1 | `#FFFFFF`（白） |
| ★2 | `#00FF00`（緑） |
| ★3 | `#0088FF`（青） |
| ★4 | `#AA00FF`（紫） |
| ★5 | `#FFD700`（金）+ 点滅 |

### 色（ポータル）

| 状態 | RGB | 説明 |
|------|-----|------|
| 未訪問 | `(0, 200, 255)` | 水色（点滅） |
| 訪問済み | `(180, 100, 255)` | 紫 |
| アクセス不可 | `(100, 100, 100)` | グレー |
| 停止した敵 | `(100, 100, 100)` | グレー（半透明） |

---

## 技術仕様

### 技術スタック

| レイヤー | 技術 |
|----------|------|
| フレームワーク | Kaboom.js または Phaser 3 |
| 言語 | TypeScript推奨 |
| バンドラー | Vite |
| データ形式 | JSON |

### ディレクトリ構成（案）

```
element-hunter/
├── src/
│   ├── main.ts          # エントリーポイント
│   ├── scenes/
│   │   ├── title.ts     # タイトル画面
│   │   ├── select.ts    # サイト選択
│   │   ├── game.ts      # メインゲーム
│   │   └── collection.ts # 図鑑画面
│   ├── entities/
│   │   ├── player.ts
│   │   ├── enemy.ts
│   │   └── obstacle.ts
│   ├── systems/
│   │   ├── powerup.ts   # ゲージシステム
│   │   ├── collection.ts # 図鑑システム
│   │   └── room.ts      # 部屋生成
│   └── data/
│       └── elements.ts  # HTML要素定義
├── data/
│   └── sites/           # クロール済みサイトデータ
│       ├── tutorial.json
│       └── sample-corp.json
├── tools/
│   └── crawler/         # クロールツール
│       ├── crawl.ts
│       └── package.json
├── public/
├── index.html
├── package.json
└── vite.config.ts
```

### サイトデータ形式（JSON）

```json
{
  "siteId": "example-corp",
  "siteName": "Example株式会社",
  "pages": [
    {
      "path": "/",
      "depth": 0,
      "elements": [
        { "tag": "h1", "count": 1 },
        { "tag": "p", "count": 12 },
        { "tag": "div", "count": 45 },
        { "tag": "img", "count": 8 }
      ],
      "links": ["/about", "/products", "/contact"],
      "contentLength": 4500
    },
    {
      "path": "/products",
      "depth": 1,
      "elements": [...],
      "links": ["/", "/products/item-a", "/products/item-b"],
      "contentLength": 3200
    }
  ],
  "deepestPages": ["/products/item-a/detail"],
  "rareElements": ["video", "canvas"]
}
```

### クロールツール要件

- Puppeteer または Playwright 使用
- 入力: URL（トップページ）
- 出力: JSON（上記形式）
- 機能:
  - JSレンダリング後のDOMを取得
  - 内部リンクを再帰的にクロール
  - 深度制限（無限ループ防止）
  - 共通リンクの検出・除外

---

## MVP（Phase 1）- 完了

### 範囲

最小限の動くプロトタイプ。

#### 含むもの

- [x] 1部屋固定（ハードコードでOK）
- [x] プレイヤー移動（8方向）
- [x] 攻撃（前方に判定）
- [x] 敵3種（`<p>`, `<div>`, `<h1>`）
  - 各1パターンの動き
  - 倒すと消える
- [x] 右端にゴール（触れたらクリア表示）
- [x] HP表示（敵に当たるとダメージ）

### 完了条件

- ゲームが起動する
- プレイヤーを操作できる
- 敵が動いて、攻撃で倒せる
- 敵に当たるとダメージを受ける
- 右端でクリア表示が出る

---

## Phase 2（サイト販促モード）- 完了

- [x] JSON読み込み → 部屋生成
- [x] 複数部屋 + ポータルでの移動
- [x] ポータルは剣で攻撃して遷移（連続遷移防止）
- [x] ワープ演出（フェード + "WARP" テキスト）
- [x] 訪問済みポータルの色変更（紫色）
- [x] ポータルにページタイトル表示
- [x] TOPポータル（常にトップページに戻る）
- [x] 共通リンク（commonLinks）を経路探索に含める
- [x] 共通リンクをポータルとして表示
- [x] 敵の停止システムと状態永続化
- [x] ページクリア判定
- [x] ターゲットページ選択（BFS到達可能判定）
- [x] 2カラムレイアウト（ゲーム + コンテンツパネル）
- [x] コンテンツパネルUI（タイトル、進捗、ターゲット一覧、テキスト表示）
- [x] タイマー（経過時間計測、ゲームオーバー/完了で停止）
- [x] HP永続化（ページ間で保持）
- [x] ゲーム完了シーン
- [x] ゲームオーバー + リトライ
- [x] クローラー拡張（テキスト・画像取得）

---

## 今後の改善案

- [ ] タイトル画面（コンセプトテキスト + サイト名表示）
- [ ] サイト選択画面
- [ ] サウンド（BGM、SE）
- [ ] ダメージ演出強化
- [ ] ゲームパッド対応
- [ ] スマホ対応（タッチ操作）

### タイトル画面のイメージ

```
╔══════════════════════════════════════════╗
║                                          ║
║          E L E M E N T                   ║
║            H U N T E R                   ║
║                                          ║
║   私はエレメントハンター。               ║
║   逃げ出したHTML要素をハントするのが     ║
║   仕事だ。                               ║
║                                          ║
║   今日の舞台は Agile Studio。            ║
║   さあ、さっさと捕まえて                 ║
║   コンテンツを取り戻してやるぜ。         ║
║                                          ║
║         [ PRESS SPACE TO START ]         ║
║                                          ║
╚══════════════════════════════════════════╝
```

---

## 備考

### 法的考慮

- 事前クロールするサイトは許可を取るか、自作する
- 収集したデータはゲームにバンドルし、リアルタイムクロールはしない

### バランス調整

- HP、攻撃力、移動速度等の数値は仮
- プレイしながら調整

---

## 将来構想（アイディアノート）

以下は現在のタイムアタックモードとは別軸の構想。実装予定なし。

### 図鑑モード

敵を「倒す」（消える）形式で、HTML要素を収集する長期プレイモード。

- 敵を倒すと図鑑に登録
- 全HTML要素（約118種）のコンプリートが目標
- レアリティ表示、収集率表示
- 称号システム（50%: HTML見習い、100%: HTMLマスター）
- セーブ/ロード機能

### パワーアップシステム（グラディウス式）

```
[回復] → [攻撃UP] → [速度UP] → [無敵] → [全体攻撃]
  1個      2個        3個        4個        5個
```

- 敵を倒すとカプセルドロップ
- カプセル取得でゲージ+1
- ボタンで効果発動、ゲージリセット

### 障害物システム

| 種類 | 表示 | 耐久 | ドロップ |
|------|------|------|----------|
| 箱 | `[箱]` | 1発 | ランダム |
| 樽 | `[樽]` | 1発 | ランダム |
| 岩 | `[岩]` | 2-3発 | 良いものが出やすい |

### その他アイディア

- マルチプレイ（同じサイトを複数人で探索）
- デイリーチャレンジ（日替わりサイト）
- 外部リンク → 別サイトへワープ
- ランキング機能
